{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    
    <h1 class="mb-4">Résultats de la recherche</h1>
    <form method="GET" action="{% url 'app:search_results' %}" class="search-bar form-inline mb-4">
        <div class="input-group mr-2">
            <input type="text" name="q" class="form-control" placeholder="Rechercher une question..." value="{{ request.GET.q }}" id="autocomplete-input">
        </div>
        <div class="input-group mr-2">
            <select name="serie" id="series-filter" class="selectpicker form-control" multiple title="Séries">
                {% for serie in series %}
                    <option value="{{ serie.id }}" {% if serie.id|stringformat:"s" in selected_series %}selected{% endif %}>
                        {{ serie.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="input-group mr-2">
            <select name="survey" id="study-filter" class="selectpicker form-control" multiple title="Études">
                {% for study in studies %}
                    <option value="{{ study.id }}" {% if study.id|stringformat:"s" in selected_studies %}selected{% endif %}>
                        {{ study.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="input-group mr-2">
            <select name="search_location" id="search-location" class="form-select selectpicker">
                <option value="questions" {% if search_location == 'questions' %}selected{% endif %}>Questions</option>
                <option value="categories" {% if search_location == 'categories' %}selected{% endif %}>Modalités</option>
                <option value="variable_name" {% if request.GET.search_location == 'variable_name' %}selected{% endif %}>Nom de la variable</option>
            </select>
        </div>
        <button type="submit" class="btn btn-outline-primary mx-2"><i class="fa-solid fa-magnifying-glass pr-2"></i>Rechercher</button>
    </form>
    <table id="survey-table" class="table table-striped table-bordered display" style="width:100%">
        <thead class="table-dark" style="display:none">
            <tr>
                <th>Enquête</th>
            </tr>
        </thead>
    </table>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/search_results.css' %}">
<style>
    .badge-category {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #007bff;
        color: white;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 0.8em;  /* Taille des lettres du badge */
        cursor: pointer;
        z-index: 1; /* S'assurer que le badge est au-dessus du texte */
        width: 15rem;
    }

    .category-dropdown {
        display: none;
        position: absolute;
        top: 30px;
        right: 10px;
        background-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        z-index: 1;
        width: 15rem;
        padding: 10px;
        border-radius: 3px;

        /* Limiter la hauteur du dropdown à la hauteur de la carte */
        max-height: calc(100% - 40px); /* Limite à la hauteur de la carte parent, en laissant 40px de marge */
        overflow-y: auto; /* Scroll si nécessaire */
    }

    .category-item {
        padding: 5px;
        font-size: 0.75em;  /* Réduit la taille du texte dans les catégories */
    }

    /* Surlignement de la catégorie correspondante */
    .highlight-category {
        background-color: yellow;
        font-weight: bold;
    }

    /* Style pour le dropdown */
    .category-dropdown a {
        display: block;
        padding: 5px;
        text-decoration: none;
        color: black;
        font-size: 0.75em; /* Réduit la taille du texte dans les liens */
    }

    .category-dropdown a:hover {
        background-color: #f1f1f1;
    }

    /* Le conteneur de la carte doit être positionné */
    .card {
        position: relative; /* Important pour confiner le dropdown à la carte */
        margin-bottom: 20px;

        overflow: hidden; /* Empêche le dépassement du contenu */
    }

    .bootstrap-select .btn {
        max-width: 200px; /* Limite la largeur maximale du bouton */
        max-height: 40px; /* Limite la hauteur maximale du bouton */
        overflow: hidden; /* Cache le texte qui dépasse */
        text-overflow: ellipsis; /* Affiche "..." si le texte est trop long */
        white-space: nowrap; /* Empêche le texte de passer à la ligne */
    }
    
</style>

{% endblock %}

{% block extra_js %}
<meta name="autocomplete-url" content="{% url 'autocomplete' %}">
<script src="{% static 'js/search_elastic.js' %}"></script>
<script>

$(document).ready(function() {

    const seriesFilter = document.getElementById('series-filter');
    const surveysFilter = document.getElementById('study-filter');

    seriesFilter.addEventListener('change', function () {
        const selectedSeries = Array.from(seriesFilter.selectedOptions).map(option => option.value);
        const selectedStudies = Array.from(surveysFilter.selectedOptions).map(option => option.value);

        fetch(`/api/get-surveys-by-series/?series_ids=${selectedSeries.join(',')}`)
            .then(response => response.json())
            .then(data => {
                surveysFilter.innerHTML = '';

                data.surveys.forEach(survey => {
                    const option = document.createElement('option');
                    option.value = survey.id;
                    option.text = survey.name;
                    if (selectedStudies.includes(String(survey.id))) {
                        option.selected = true;
                    }
                    surveysFilter.appendChild(option);
                });
                $('.selectpicker').selectpicker('refresh');
            });
        $('#survey-table').DataTable().ajax.reload();
    });
    $(document).on('click', '.badge-category', function() {
        var dropdown = $(this).siblings('.category-dropdown');
        $('.category-dropdown').not(dropdown).hide();
        dropdown.toggle();
    });

    $(document).click(function(event) {
        if (!$(event.target).closest('.badge-category, .category-dropdown').length) {
            $('.category-dropdown').hide();
        }
    });
    $(document).on('click', '.badge-category', function() {
        var matchedCategory = $(this).text().trim();
        var dropdown = $(this).siblings('.category-dropdown');
        dropdown.find('.category-item').each(function() {
            if ($(this).text().trim() === matchedCategory) {
                $(this).addClass('highlight-category');
            } else {
                $(this).removeClass('highlight-category');
            }
        });
    });
    function getStudyFilter() {
        return $('#study-filter').val() || [];
    }

    function getSerieFilter() {
        return $('#series-filter').val() || [];
    }

    function getSearchLocation() {
        return $('#search-location').val() || 'questions';
    }

    $('.selectpicker').selectpicker({
        noneSelectedText: 'Sélectionner une ou plusieurs options',
        showTick: true,
        liveSearch: true,
        actionsBox: true,
        selectedTextFormat: 'count > 1',
        countSelectedText: function(numSelected, numTotal) {
            return (numSelected === 1) ? "{0} sélectionnée" : "{0} sélectionnées";
        },
    });
    $('.selectpicker').selectpicker('refresh');

    $('#survey-table').DataTable({
        "ordering": false,
        "dom": '<"top"i>rt<"bottom"lp><"clear">',
        'order': [[0, 'desc']],
        "lengthMenu": [ [10, 25, 50, 100, -1], [10, 25, 50, 100, "Tous"] ],
        "processing": true,
        "serverSide": true,
        "pagingType": "full_numbers",
        "ajax": {
            "url": "{% url 'app:search_results_data' %}",
            "type": "GET",
            "async": true,
            "data": function(d) {
                d.q = "{{ request.GET.q }}";
                d.study = getStudyFilter();
                d.series = getSerieFilter();
                d.search_location = getSearchLocation();
            },
            "headers": {'X-CSRFToken' : $("input[name=csrfmiddlewaretoken]").val() },
        },
        "columns": [
        {
                "data": "id",  
                "render": function (data, type, row) {
                    console.log(row.id)
                    console.log(row)
                    var url = '/question/' + row.id + '/';
                    var categoriesDisplay = row.categories.map(function(category) {
                        return `${category}`;
                    }).join("<br>");
                    return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">
                                <a class="custom-name-card" href="` + url + `">` + row.question_text + `</a>
                            </h5>
                            <h6 class="card-subtitle mb-2 text-muted">Enquête : ` + row.survey_name + `</h6>
                            <h6 class="card-subtitle mb-2 text-muted">Nom de la variable : ` + row.variable_name + `</h6>
                            <h6 class="card-subtitle mb-2 text-muted">Label interne : ` + row.internal_label + `</h6>
                                                 <!-- Bouton pour afficher les catégories -->
                            <button class="btn btn-secondary" id="toggle-categories" onclick="toggleCategories('categories-` + row.id + `')">Modalités</button>
                            
                            <!-- Liste des catégories, affichée directement si is_category_search est True -->
                            <div id="categories-` + row.id + `" class="categories-list mt-3" style="` + (row.is_category_search ? 'display: block;' : 'display: none;') + `">
                                ` + categoriesDisplay + `
                            </div>
                        </div>
                    </div>`;
                }
            },
        ],
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.20/i18n/French.json",
            "processing": "",
            "info": "Affichage de _START_ à _END_ sur _TOTAL_ entrées",
            "paginate": {
                "first": "Première",
                "last": "Dernière",
                "next": "Suivante",
                "previous": "Précédente"
            }
        }
    });

    $('#study-filter').on('change', function() {
        $('#survey-table').DataTable().ajax.reload();
    });
});


function deleteSurvey(id) {
    // Code pour supprimer l'enquête
    alert('Supprimer l\'enquête ' + id);
}
function toggleCategories(categoryId) {
    var categoriesDiv = document.getElementById(categoryId);
    if (categoriesDiv.style.display === "none") {
        categoriesDiv.style.display = "block"; // Affiche la liste
    } else {
        categoriesDiv.style.display = "none"; // Cache la liste
    }
}
</script>
{% endblock %}