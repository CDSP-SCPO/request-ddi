{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block content %}
    <div class="inner-container-custom d-flex">
        <div class="search-results-container w-70 border-right-custom">
            <div class="height_topbar d-flex justify-content-between align-items-center custom-topbar border-bottom-custom">
                <div class="export-container custom-body d-flex justify-content-between align-items-center">
                    <span id="results-count">0 {% trans "résultats" %}</span>
                    <div class="d-flex align-items-center container-buttons-export">
                        <div id="export-selected" class="white-button custom-text-white-buttons" type="button">
                            <img src="{% static 'svg/icons/export.svg' %}">
                            <span>{% trans "Exporter la sélection" %}</span>
                        </div>
                        <div id="export-all" class="white-button custom-text-white-buttons" type="button">
                            <img src="{% static 'svg/icons/export.svg' %}">
                            <span>{% trans "Tout exporter" %}</span>
                        </div>
                    
                    </div>
                </div>
            </div>
            <div id="selected-filters-container" class="selected-filters-container overflow-auto">
            </div>
            <div class="table-container">
                <table id="survey-table" class="" style="width:100%">
                    <thead class="table-dark" style="display:none">
                    <tr>
                        <th>Enquête</th>
                    </tr>
                    </thead>
                </table>
                <div class="container-button-load-more">
                    <div type="button" id="load-more" class="load-more-button white-button custom-text-white-buttons">{% trans "Charger plus" %}</div>
                </div>
            </div>
        </div>
        <div class="filters-container w-30">
            <div class="height_topbar border-bottom-custom padding-filters-container">
                <div class="custom-body color-grey-1">
                    {% trans "Filtrer par" %}
                </div>
            </div>
            <div class="accordion" id="filtersAccordion">
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingOne">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                            <div class="collapse-title">
                                <span>{% trans "Types de métadonnées" %}</span>
                                <span class="filter-count"></span>
                            </div>
                            <i class="fas fa-caret-down icon-caret"></i>
                        </div>
                    </div>
                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" >
                        <div class="accordion-body">
                            <div id="search-location" class="div-all-checkboxes">
                                <div class="form-check-custom">
                                    <input class="form-check-input search-location-checkbox checkbox-custom" type="checkbox" value="questions" id="search-location-questions">
                                    <label class="form-check-label" for="search-location-questions">{% trans "Questions" %}</label>
                                </div>
                                <div class="form-check-custom">
                                    <input class="form-check-input search-location-checkbox checkbox-custom" type="checkbox" value="categories" id="search-location-categories">
                                    <label class="form-check-label" for="search-location-categories">{% trans "Modalités" %}</label>
                                </div>
                                <div class="form-check-custom">
                                    <input class="form-check-input search-location-checkbox checkbox-custom" type="checkbox" value="variable_name" id="search-location-variable_name">
                                    <label class="form-check-label" for="search-location-variable_name">{% trans "Nom de la variable" %}</label>
                                </div>
                                <div class="form-check-custom">
                                    <input class="form-check-input search-location-checkbox checkbox-custom" type="checkbox" value="internal_label" id="search-location-internal_label">
                                    <label class="form-check-label" for="search-location-internal_label">{% trans "Libellé de la variable" %}</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingTwo">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            <div class="collapse-title">
                                <span>{% trans "Collections" %}</span>
                                <span class="filter-count"></span>
                            </div>
                            <i class="fas fa-caret-down icon-caret"></i>
                        </div>
                    </div>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" >
                        <div class="accordion-body">
                            <div id="collections-filter" class="div-all-checkboxes">
                                {% for collection in collections %}
                                    <div class="form-check-custom">
                                        <input class="form-check-input collection-checkbox checkbox-custom" type="checkbox" value="{{ collection.id }}" id="collection-{{ collection.id }}" {% if collection.id|stringformat:"s" in request.session.selected_collection %}checked{% endif %}>
                                        <label class="form-check-label" for="collection-{{ collection.id }}">
                                            {{ collection.name }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingThree">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            <div class="collapse-title">
                                <span>{% trans "Sous-collections" %}</span>
                                <span class="filter-count"></span>
                            </div>
                            <i class="fas fa-caret-down icon-caret"></i>
                        </div>
                    </div>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree">
                        <div class="accordion-body">
                            <div id="subcollections-filter" class="div-all-checkboxes">
                                {% for subcollection in subcollections %}
                                    <div class="form-check-custom">
                                        <input class="form-check-input subcollection-checkbox checkbox-custom" type="checkbox" value="{{ subcollection.id }}" id="subcollection-{{ subcollection.id }}" {% if subcollection.id|stringformat:"s" in request.session.selected_sub_collection %}checked{% endif %}>
                                        <label class="form-check-label" for="subcollection-{{ subcollection.id }}">
                                            {{ subcollection.name }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingFour">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button" data-toggle="collapse" data-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                            <div class="collapse-title">
                                <span>{% trans "Enquêtes" %}</span>
                                <span class="filter-count"></span>
                            </div>
                            <i class="fas fa-caret-down icon-caret"></i>
                        </div>
                    </div>
                    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" >
                        <div class="accordion-body">
                            <div id="survey-filter" class="div-all-checkboxes">
                                {% for survey in surveys %}
                                    <div class="form-check-custom">
                                        <input class="form-check-input survey-checkbox checkbox-custom" type="checkbox" value="{{ survey.id }}" id="survey-{{ survey.id }}" {% if survey.id|stringformat:"s" in request.session.selected_surveys %}checked{% endif %}>
                                        <label class="form-check-label" for="survey-{{ survey.id }}">
                                            {{ survey.name }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingFive">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button" data-toggle="collapse" data-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                            <div class="collapse-title">
                                <span>{% trans "Années" %}</span>
                                <span class="filter-count"></span>
                            </div>
                            <i class="fas fa-caret-down icon-caret"></i>
                        </div>
                    </div>
                    <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive">
                        <div class="accordion-body" class="div-all-checkboxes">
                            <div id="years-filter">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="reset-filters-container padding-filters-container">
                <div class="container-reset-button">
                    <div type="button" id="reset-filters" class="white-button custom-text-white-buttons">
                        <img src="{% static 'svg/icons/reset.svg' %}" class="reset-icon" alt="reset-icon">
                        <span>{% trans "Réinitialiser" %}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/search_results.css' %}">
    <style>
        
        :root {
            --selected-filters-container-height: 0px;
        }
        .inner-container-custom{
            --topbar-height : 64px;
            --resetbar-height : 64px;
        }
        .search-results-container {
            width: 70%;
            overflow: hidden;
        }
        .filters-container {
            width: 30%;
        }
        .badge-category {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #007bff;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.8em; /* Taille des lettres du badge */
            cursor: pointer;
            z-index: 1; /* S'assurer que le badge est au-dessus du texte */
            width: 15rem;
        }
        .category-dropdown {
            display: none;
            position: absolute;
            top: 30px;
            right: 10px;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1;
            width: 15rem;
            padding: 10px;
            border-radius: 3px;
            max-height: calc(100% - 40px); /* Limite à la hauteur de la carte parent, en laissant 40px de marge */
            overflow-y: auto; /* Scroll si nécessaire */
        }
        .category-item {
            padding: 5px;
            font-size: 0.75em; /* Réduit la taille du texte dans les catégories */
        }
        .highlight-category {
            background-color: rgba(255, 70, 78, 0.15);
            font-weight: bold;
        }
        .category-dropdown a {
            display: block;
            padding: 5px;
            text-decoration: none;
            color: black;
            font-size: 0.75em; /* Réduit la taille du texte dans les liens */
        }
        .category-dropdown a:hover {
            background-color: #f1f1f1;
        }
        .card {
            position: relative; /* Important pour confiner le dropdown à la carte */
            margin-bottom: 20px;
            overflow: hidden; /* Empêche le dépassement du contenu */
        }
        .bootstrap-select .btn {
            max-width: 200px;
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
{% endblock %}

{% block extra_js %}
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>

    <script src="{% static 'js/search_results/utils.js' %}"></script>
    <script src="{% static 'js/search_results/filters.js' %}"></script>
    <script src="{% static 'js/search_results/decades.js' %}"></script>
    <script src="{% static 'js/search_results/datatable.js' %}"></script>
    <script src="{% static 'js/search_results/events.js' %}"></script>
    <script src="{% static 'js/search_results/init.js' %}"></script>
    <script>

        function updateSubcollections(selectedCollections) {
            fetch(`/api/get-subcollections-by-collections/?collections_ids=${selectedCollections.join(',')}`)
                .then(response => response.json())
                .then(data => {
                    const subcollectionsFilter = $('#subcollections-filter');
                    subcollectionsFilter.empty();
                    const availableSubcollectionIds = data.subcollections.map(subcollection => subcollection.id);
                    data.subcollections.forEach(subcollection => {
                        const checkbox = $('<input type="checkbox" class="form-check-input subcollection-checkbox checkbox-custom" value="' + subcollection.id + '" id="subcollection-' + subcollection.id + '">');
                        const label = $('<label class="form-check-label" for="subcollection-' + subcollection.id + '">' + subcollection.name + '</label>');
                        const div = $('<div class="form-check-custom"></div>');
                        div.append(checkbox).append(label);
                        subcollectionsFilter.append(div);
                    });
                    $('.subcollection-checkbox').each(function () {
                        const subcollectionId = $(this).val();
                        if (!availableSubcollectionIds.includes(subcollectionId)) {
                            $(this).prop('checked', false);
                        }
                    });
                    attachDynamicCheckboxEvents();
                    updateFilterCounts();
                    const allSubcollections = data.subcollections.map(subcollection => subcollection.id);
                    updateSurveys(allSubcollections);
                });
        }

        function updateSurveys(selectedSubcollections) {
            fetch(`/api/get-surveys-by-subcollections/?subcollections_ids=${selectedSubcollections.join(',')}`)
                .then(response => response.json())
                .then(data => {
                    const surveysFilter = $('#survey-filter');
                    surveysFilter.empty();
                    const availableSurveyIds = data.surveys.map(survey => survey.id);
                    data.surveys.forEach(survey => {
                        const checkbox = $('<input type="checkbox" class="form-check-input survey-checkbox checkbox-custom" value="' + survey.id + '" id="survey-' + survey.id + '">');
                        const label = $('<label class="form-check-label" for="survey-' + survey.id + '">' + survey.name + '</label>');
                        const div = $('<div class="form-check-custom"></div>');
                        div.append(checkbox).append(label);
                        surveysFilter.append(div);
                    });
                    $('.survey-checkbox').each(function () {
                        const surveyId = $(this).val();
                        if (!availableSurveyIds.includes(surveyId)) {
                            $(this).prop('checked', false);
                        }
                    });
                    attachDynamicCheckboxEvents();
                    updateFiltersDisplay();
                    updateFilterCounts();
                });
        }

        function handleFilterChange(filterType, filterValue, filterLabel) {
            selectedIds.clear();
            if (!selectedFilters[filterType]) {
                selectedFilters[filterType] = [];
            }
            var existingFilterIndex = selectedFilters[filterType].findIndex(f => f.value === filterValue);
            if (existingFilterIndex !== -1) {
                selectedFilters[filterType].splice(existingFilterIndex, 1);
            } else {
                selectedFilters[filterType].push({value: filterValue, label: filterLabel});
            }
            updateFiltersDisplay();
            loadDecades();
            $('#survey-table').DataTable().ajax.reload();
        }

        function updateCheckboxes() {
            $('#survey-table tbody input[type="checkbox"]').each(function() {
                if (selectedIds.has(this.value)) {
                    this.checked = true;
                } else {
                    this.checked = false;
                }
            });
        }

        async function applyFiltersFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const q = urlParams.get('q');
            if (q) {
                $('input[name="q"]').val(q);
            }

            // Étape 1 : cocher les collections

            const collections = urlParams.getAll('collections');
            collections.forEach(val => {
                $(`.collection-checkbox[value="${val}"]`).prop('checked', true).trigger('change');
            });

            // Étape 2 : charger les sous-collections si nécessaire

            const subCollections = urlParams.getAll('sub_collections');
            if (collections.length > 0 || subCollections.length > 0) {
                if (collections.length === 0) {
                    await waitForElement('.collection-checkbox');
                    const allCollectionIds = $('.collection-checkbox').map(function () {
                        return this.value;
                    }).get();
                    updateSubcollections(allCollectionIds);
                }
                await waitForElement('.subcollection-checkbox');
                subCollections.forEach(val => {
                    $(`.subcollection-checkbox[value="${val}"]`).prop('checked', true).trigger('change');
                });
            }

            // Étape 3 : cocher les enquêtes

            const surveys = urlParams.getAll('survey');
            if (surveys.length > 0) {
                await waitForElement('.survey-checkbox');
                surveys.forEach(val => {
                    $(`.survey-checkbox[value="${val}"]`).prop('checked', true).trigger('change');
                });
            }

            // Étape 4 : cocher les lieux de recherche

            const searchLocations = urlParams.getAll('search_location');
            searchLocations.forEach(val => {
                $(`.search-location-checkbox[value="${val}"]`).prop('checked', true).trigger('change');
            });

            // Étape 5 : charger les décennies

            await loadDecades();

            // Étape 6 : gérer les années individuelles

            const years = urlParams.getAll('years');
            years.forEach(year => {
                addYearToFilters(parseInt(year));
            });

            // Étape 7 : ouvrir les décennies concernées et cocher les années
            
            const decadesToOpen = new Set();
            years.forEach(year => {
                const decade = Math.floor(parseInt(year) / 10) * 10;
                decadesToOpen.add(decade);
            });
            for (const decade of decadesToOpen) {
                await loadYears(decade.toString());
                years.forEach(year => {
                    if (Math.floor(parseInt(year) / 10) * 10 === decade) {
                        const checkbox = $(`.year-checkbox[value="${year}"]`);
                        if (checkbox.length > 0) {
                            checkbox.prop('checked', true);
                            addYearToFilters(parseInt(year));
                        }
                    }
                });
            }
            updateFiltersDisplay();
            updateFilterCounts();
            $('#survey-table').DataTable().ajax.reload();
        }

        function updateFilters() {
            $('#survey-table').DataTable().ajax.reload();
        }
    </script>
{% endblock %}
