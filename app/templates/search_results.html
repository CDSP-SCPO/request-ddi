{% extends 'base.html' %}
{% load static %}

{% block content %}
    <div class="inner-container-custom d-flex">
        <div class="search-results-container w-70 border-right-custom">
            <div class="height_topbar d-flex justify-content-between align-items-center custom-topbar border-bottom-custom">
                <div class="export-container custom-body d-flex justify-content-between align-items-center">
                    <span id="results-count">0 résultats</span>
                    <div class="d-flex align-items-center container-buttons-export">
                        <div id="export-selected" class="export-link" type="button">
                            <img src="{% static 'svg/icons/export.svg' %}">
                            <span>Exporter la sélection</span>
                        </div>
                        <div id="export-all" class="export-link" type="button">
                            <img src="{% static 'svg/icons/export.svg' %}">
                            <span>Tout exporter</span>
                        </div>

                    </div>
                </div>
            </div>
            <div id="selected-filters-container" class="selected-filters-container overflow-auto">
            </div>
            <div class="table-container">
                <table id="survey-table" class="" style="width:100%">
                    <thead class="table-dark" style="display:none">
                    <tr>
                        <th>Enquête</th>
                    </tr>
                    </thead>
                </table>
                <div type="button" id="load-more" class="load-more-button">Charger plus</div>
            </div>
        </div>
        <div class="filters-container w-30">
            <div class="height_topbar border-bottom-custom padding-filters-container">
                <div class="custom-body color-grey-1">
                    Filtrer par
                </div>
            </div>
            <div class="accordion" id="filtersAccordion">
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingOne">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button"
                             data-toggle="collapse" data-target="#collapseOne" aria-expanded="false"
                             aria-controls="collapseOne">
                            <span>Types de métadonnées</span>
                            <span class="filter-count"></span>
                            <i class="fas fa-caret-down"></i>
                        </div>
                    </div>
                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne">
                        <div class="accordion-body">
                            <div id="search-location" class="div-all-checkboxes">
                                <div class="form-check-custom">
                                    <input class="form-check-input search-location-checkbox checkbox-custom"
                                           type="checkbox" value="questions" id="search-location-questions">
                                    <label class="form-check-label" for="search-location-questions">Questions</label>
                                </div>
                                <div class="form-check-custom">
                                    <input class="form-check-input search-location-checkbox checkbox-custom"
                                           type="checkbox" value="categories" id="search-location-categories">
                                    <label class="form-check-label" for="search-location-categories">Modalités</label>
                                </div>
                                <div class="form-check-custom">
                                    <input class="form-check-input search-location-checkbox checkbox-custom"
                                           type="checkbox" value="variable_name" id="search-location-variable_name">
                                    <label class="form-check-label" for="search-location-variable_name">Nom de la
                                        variable</label>
                                </div>
                                <div class="form-check-custom">
                                    <input class="form-check-input search-location-checkbox checkbox-custom"
                                           type="checkbox" value="internal_label" id="search-location-internal_label">
                                    <label class="form-check-label" for="search-location-internal_label">Libellé de la
                                        variable</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingTwo">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button"
                             data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false"
                             aria-controls="collapseTwo">
                            <span>Collections</span>
                            <span class="filter-count"></span>
                            <i class="fas fa-caret-down"></i>
                        </div>
                    </div>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo">
                        <div class="accordion-body">
                            <div id="collections-filter" class="div-all-checkboxes">
                                {% for collection in collections %}
                                    <div class="form-check-custom">
                                        <input class="form-check-input collection-checkbox checkbox-custom"
                                               type="checkbox" value="{{ collection.id }}"
                                               id="collection-{{ collection.id }}"
                                               {% if collection.id|stringformat:"s" in request.session.selected_collection %}checked{% endif %}>
                                        <label class="form-check-label" for="collection-{{ collection.id }}">
                                            {{ collection.name }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingThree">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button"
                             data-toggle="collapse" data-target="#collapseThree" aria-expanded="false"
                             aria-controls="collapseThree">
                            <span>Sous-Collections</span>
                            <span class="filter-count"></span>
                            <i class="fas fa-caret-down"></i>
                        </div>
                    </div>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree">
                        <div class="accordion-body">
                            <div id="subcollections-filter" class="div-all-checkboxes">
                                {% for subcollection in subcollections %}
                                    <div class="form-check-custom">
                                        <input class="form-check-input subcollection-checkbox checkbox-custom"
                                               type="checkbox" value="{{ subcollection.id }}"
                                               id="subcollection-{{ subcollection.id }}"
                                               {% if subcollection.id|stringformat:"s" in request.session.selected_sub_collection %}checked{% endif %}>
                                        <label class="form-check-label" for="subcollection-{{ subcollection.id }}">
                                            {{ subcollection.name }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingFour">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button"
                             data-toggle="collapse" data-target="#collapseFour" aria-expanded="false"
                             aria-controls="collapseFour">
                            <span>Enquêtes</span>
                            <span class="filter-count"></span>
                            <i class="fas fa-caret-down"></i>
                        </div>
                    </div>
                    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour">
                        <div class="accordion-body">
                            <div id="survey-filter" class="div-all-checkboxes">
                                {% for survey in surveys %}
                                    <div class="form-check-custom">
                                        <input class="form-check-input survey-checkbox checkbox-custom" type="checkbox"
                                               value="{{ survey.id }}" id="survey-{{ survey.id }}"
                                               {% if survey.id|stringformat:"s" in request.session.selected_surveys %}checked{% endif %}>
                                        <label class="form-check-label" for="survey-{{ survey.id }}">
                                            {{ survey.name }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingFive">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button"
                             data-toggle="collapse" data-target="#collapseFive" aria-expanded="false"
                             aria-controls="collapseFive">
                            <span>Années</span>
                            <i class="fas fa-caret-down"></i>
                        </div>
                    </div>
                    <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive">
                        <div class="accordion-body" class="div-all-checkboxes">
                            <div id="years-filter">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="reset-filters-container padding-filters-container">
                <div class="container-reset-button">
                    <div type="button" id="reset-filters" class="reset-button">
                        <img src="{% static 'svg/icons/reset.svg' %}" class="reset-icon" alt="reset-icon">
                        <span>Réinitialiser</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/search_results.css' %}">
    <style>

        .inner-container-custom {
            --topbar-height: 64px;
            --resetbar-height: 64px;
        }

        .search-results-container {
            width: 70%;
            overflow: hidden;
        }

        .filters-container {
            width: 30%;
        }

        .badge-category {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #007bff;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.8em; /* Taille des lettres du badge */
            cursor: pointer;
            z-index: 1; /* S'assurer que le badge est au-dessus du texte */
            width: 15rem;
        }

        .category-dropdown {
            display: none;
            position: absolute;
            top: 30px;
            right: 10px;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1;
            width: 15rem;
            padding: 10px;
            border-radius: 3px;
            max-height: calc(100% - 40px); /* Limite à la hauteur de la carte parent, en laissant 40px de marge */
            overflow-y: auto; /* Scroll si nécessaire */
        }

        .category-item {
            padding: 5px;
            font-size: 0.75em; /* Réduit la taille du texte dans les catégories */
        }

        .highlight-category {
            background-color: yellow;
            font-weight: bold;
        }

        .category-dropdown a {
            display: block;
            padding: 5px;
            text-decoration: none;
            color: black;
            font-size: 0.75em; /* Réduit la taille du texte dans les liens */
        }

        .category-dropdown a:hover {
            background-color: #f1f1f1;
        }

        .card {
            position: relative; /* Important pour confiner le dropdown à la carte */
            margin-bottom: 20px;
            overflow: hidden; /* Empêche le dépassement du contenu */
        }

        .bootstrap-select .btn {
            max-width: 200px;
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
{% endblock %}

{% block extra_js %}
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script>
        $(document).ready(function () {
            var selectedIds = new Set();
            var selectedFilters = {}; // Object to store selected filters

            function updateFiltersDisplay() {
                const filterContainer = $('#selected-filters-container');
                filterContainer.empty();

                let hasFilters = false;

                $.each(selectedFilters, function (key, filters) {
                    const validFilters = filters.filter(function (filter) {
                        return $('input[type="checkbox"][value="' + filter.value + '"]').length > 0;
                    });

                    selectedFilters[key] = validFilters; // met à jour l'objet

                    if (validFilters.length > 0) {
                        hasFilters = true;
                        validFilters.forEach(function (filter) {
                            var card = $('<div class="selected-filter-card"> <span>' + filter.label + '</span> <span class="remove-filter">✖</span></div>');
                            card.find('.remove-filter').click(function () {
                                var index = selectedFilters[key].findIndex(f => f.value === filter.value);
                                if (index !== -1) {
                                    selectedFilters[key].splice(index, 1);
                                    updateFiltersDisplay();
                                    $('#survey-table').DataTable().ajax.reload();
                                }
                            });
                            filterContainer.append(card);
                        });
                    }
                });

                if (hasFilters) {
                    filterContainer.show();
                } else {
                    filterContainer.hide();
                }
            }


            updateFiltersDisplay()

            function handleFilterChange(filterType, filterValue, filterLabel) {
                if (!selectedFilters[filterType]) {
                    selectedFilters[filterType] = [];
                }

                // Check if the filter is already selected and remove if necessary
                var existingFilterIndex = selectedFilters[filterType].findIndex(f => f.value === filterValue);
                if (existingFilterIndex !== -1) {
                    selectedFilters[filterType].splice(existingFilterIndex, 1); // De-select the filter
                } else {
                    selectedFilters[filterType].push({value: filterValue, label: filterLabel}); // Add filter
                }

                updateFiltersDisplay();
                $('#survey-table').DataTable().ajax.reload(); // Reload based on new filters
            }

            

            function attachDynamicCheckboxEvents() {
                $('.subcollection-checkbox, .survey-checkbox').off('change').on('change', function () {
                    var checkbox = $(this);
                    var filterType = checkbox.attr('class').split(' ')[1].split('-')[0];
                    var filterValue = checkbox.val();
                    var filterLabel = $('label[for="' + checkbox.attr('id') + '"]').text();

                    handleFilterChange(filterType, filterValue, filterLabel);
                    updateFilterCounts();
                    if (filterType === 'subcollection') {
                        const selectedSubcollections = $('.subcollection-checkbox:checked').map(function () {
                            return this.value;
                        }).get();

                        if (selectedSubcollections.length === 0) {
                            const allSubcollections = $('.subcollection-checkbox').map(function () {
                                return this.value;
                            }).get();
                            updateSurveys(allSubcollections);
                        } else {
                            updateSurveys(selectedSubcollections);
                        }
                    }
                    $('#survey-table').DataTable().ajax.reload();
                });
                $('.survey-checkbox').off('change').on('change', function () {
                    var checkbox = $(this);
                    var filterType = checkbox.attr('class').split(' ')[1].split('-')[0];
                    var filterValue = checkbox.val();
                    var filterLabel = $('label[for="' + checkbox.attr('id') + '"]').text();

                    handleFilterChange(filterType, filterValue, filterLabel);
                    updateFilterCounts();
                });
            }

            attachDynamicCheckboxEvents()

            $('.collection-checkbox, .search-location-checkbox').on('change', function () {
                var checkbox = $(this);
                var filterType = checkbox.attr('class').split(' ')[1].split('-')[0];
                var filterValue = checkbox.val();
                var filterLabel = $('label[for="' + checkbox.attr('id') + '"]').text();

                handleFilterChange(filterType, filterValue, filterLabel);
                updateFilterCounts();

                if (filterType === 'collection') {
                    const selectedCollections = $('.collection-checkbox:checked').map(function () {
                        return this.value;
                    }).get();

                    updateSubcollections(selectedCollections);
                }
                $('#survey-table').DataTable().ajax.reload();
            });

            function updateSubcollections(selectedCollections) {
                fetch(`/api/get-subcollections-by-collections/?collections_ids=${selectedCollections.join(',')}`)
                    .then(response => response.json())
                    .then(data => {
                        const subcollectionsFilter = $('#subcollections-filter');
                        subcollectionsFilter.empty();
                        const availableSubcollectionIds = data.subcollections.map(subcollection => subcollection.id);
                        data.subcollections.forEach(subcollection => {
                            const checkbox = $('<input type="checkbox" class="form-check-input subcollection-checkbox checkbox-custom" value="' + subcollection.id + '" id="subcollection-' + subcollection.id + '">');
                            const label = $('<label class="form-check-label" for="subcollection-' + subcollection.id + '">' + subcollection.name + '</label>');
                            const div = $('<div class="form-check-custom"></div>');
                            div.append(checkbox).append(label);
                            subcollectionsFilter.append(div);
                        });
                        $('.subcollection-checkbox').each(function () {
                            const subcollectionId = $(this).val();
                            if (!availableSubcollectionIds.includes(subcollectionId)) {
                                $(this).prop('checked', false);
                            }
                        });

                        attachDynamicCheckboxEvents();
                        updateFilterCounts();
                        const allSubcollections = data.subcollections.map(subcollection => subcollection.id);
                        updateSurveys(allSubcollections);
                    });
            }

            function updateSurveys(selectedSubcollections) {
                fetch(`/api/get-surveys-by-subcollections/?subcollections_ids=${selectedSubcollections.join(',')}`)
                    .then(response => response.json())
                    .then(data => {
                        const surveysFilter = $('#survey-filter');
                        surveysFilter.empty();
                        const availableSurveyIds = data.surveys.map(survey => survey.id);
                        data.surveys.forEach(survey => {
                            const checkbox = $('<input type="checkbox" class="form-check-input survey-checkbox checkbox-custom" value="' + survey.id + '" id="survey-' + survey.id + '">');
                            const label = $('<label class="form-check-label" for="survey-' + survey.id + '">' + survey.name + '</label>');
                            const div = $('<div class="form-check-custom"></div>');
                            div.append(checkbox).append(label);
                            surveysFilter.append(div);
                        });
                        $('.survey-checkbox').each(function () {
                            const surveyId = $(this).val();
                            if (!availableSurveyIds.includes(surveyId)) {
                                $(this).prop('checked', false);
                            }
                        });
                        attachDynamicCheckboxEvents();
                        updateFiltersDisplay();
                        updateFilterCounts();
                    });
            }

            function getFilterValues(className) {
                return $(`.${className}:checked`).map(function() {
                    return this.value;
                }).get();
            }


            function getSearchLocation() {
                var searchLocation = $('.search-location-checkbox:checked').map(function () {
                    return this.value;
                }).get();
                return searchLocation;
            }

            var currentLimit = 10;
            var table = $('#survey-table').DataTable({
                "processing": true,
                "serverSide": true,
                "paging": false,
                "dom": 'rt',
                "info": false,
                "ordering": false,

                "ajax": {
                    "url": "{% url 'app:search_results_data' %}",
                    "type": "POST",
                    "async": true,
                    "data": function (d) {
                        d.start = d.start || 0;
                        d.limit = currentLimit;
                        d.q = "{{ request.GET.q }}";
                        d.survey = getFilterValues('survey-checkbox');
                        d.collections = getFilterValues('collection-checkbox');
                        d.sub_collections = getFilterValues('subcollection-checkbox')
                        d.search_location = getSearchLocation();
                        d.years = getYearsFilter();
                    },
                    "headers": {'X-CSRFToken': $("input[name=csrfmiddlewaretoken]").val()},
                    "dataSrc": function (json) {
                        totalRecords = json.recordsTotal;
                        currentRecords = json.data.length;
                        $('#results-count').text(totalRecords + ' résultats');
                        if (currentRecords < totalRecords) {
                            $('#load-more').show();
                        } else {
                            $('#load-more').hide();
                        }
                        return json.data;
                    },
                    "error": function (jqXHR, textStatus, errorThrown) {
                        console.error('DataTables AJAX Error:', textStatus, errorThrown);
                    }
                },
                "columns": [
                    {
                        "data": "id",
                        "render": function (data, type, row) {
                            var url = '/question/' + row.id + '/';
                            var categoriesDisplay = row.categories;
                            var survey_doi = row.survey_doi;
                            var doiUrl = 'https://doi.org/' + survey_doi;
                            var hasHighlightedModalities = row.is_category_search && row.categories && row.categories.includes('<mark style=');
                            var caretIcon = hasHighlightedModalities ?
                                '<img src="{% static "svg/buttons/caret_down_modality.svg" %}" alt="Caret Down" class="icon-caret">' :
                                '<img src="{% static "svg/buttons/caret_down.svg" %}" alt="Caret Down" class="icon-caret">'

                            return `
                                <div class="custom-card-dt">
                                    <div class="custom-content-card">
                                        <div class="custom-card-first-part">
                                            <div class="title-checkbox">
                                                <input type="checkbox" class="form-check-input checkbox-custom" value="${row.id}">
                                                <div class="custom-title-2 custom-title-2-bold">
                                                    <a class="custom-name-card color-black-1" type="button" href="${url}">${row.question_text || row.internal_label}</a>
                                                </div>
                                            </div>
                                            <div class="custom-metadatas">
                                                <div class="flex-grow-1 d-flex flex-column inner-container-metadatas">
                                                    <div class="card-subtitle text-muted">Enquête : ${row.survey_name}</div>
                                                    <div class="card-subtitle text-muted">Nom de la variable : ${row.variable_name}</div>
                                                    <div class="card-subtitle text-muted">Libellé de la variable : ${row.internal_label}</div>
                                                </div>
                                            </div>
                                            <div class="custom-card-second-part">
                                                <div class="container-buttons-card">
                                                    <span type="button" id="toggle-categories" onclick="toggleCategories('categories-${row.id}')" class="button-card">
                                                        <img src="{% static 'svg/icons/modalites.svg' %}" alt="Modalités" class="icon-modalites">
                                                        <span>Modalités</span>
                                                        ${caretIcon}
                                                    </span>

                                                    <span type="button" onclick="window.location.href='${doiUrl}'" class="button-card button-access-data">
                                                        <img src="{% static 'svg/icons/doi.svg' %}" alt="Données" class="icon-access-data">
                                                        <span>Accéder aux données</span>
                                                    </span>
                                                </div>


                                                <div id="categories-` + row.id + `" class="categories-list mt-3" style="display: none;">
                                                    ` + categoriesDisplay + `
                                                </div>
                                            </div>

                                    </div>
                                </div>`;
                        }
                    },
                ],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.20/i18n/French.json",
                    "emptyTable": "Aucun élément à afficher."
                }
            });

            $('#load-more').on('click', function () {
                currentLimit += 10;
                table.ajax.reload(null, false);
            });

            $('#survey-table tbody').on('change', 'input[type="checkbox"]', function () {
                if (this.checked) {
                    selectedIds.add(this.value);
                } else {
                    selectedIds.delete(this.value);
                }

                var allChecked = $('#survey-table tbody input[type="checkbox"]').length === $('#survey-table tbody input[type="checkbox"]:checked').length;
                $('#select-all').prop('checked', allChecked);
                $('#select-all').prop('indeterminate', !allChecked && $('#survey-table tbody input[type="checkbox"]:checked').length > 0);
            });

            $('#export-all').on('click', function () {
                window.location.href = '/export/questions/';
            });

            $('#export-selected').on('click', function () {
                if (selectedIds.size === 0) {
                    alert('Veuillez sélectionner au moins une question à exporter.');
                    return;
                }
                var selectedArray = Array.from(selectedIds);
                var queryString = selectedArray.map(id => `ids=${id}`).join('&');
                window.location.href = `/export/questions/?${queryString}`;
            });

            // Charger les décennies avec checkbox
            function loadDecades() {
                $.ajax({
                    url: '/get-decades/',
                    type: 'GET',
                    success: function (data) {
                        const decadesFilter = $('#years-filter');
                        decadesFilter.empty();
                        const sortedDecades = Object.keys(data.decades).sort((a, b) => b - a);

                        sortedDecades.forEach(decade => {
                            const years = data.decades[decade];
                            const chevronIconPath = '{% static "svg/icons/chevron_right.svg" %}';
                            const decadeDiv = $('<div class="form-check-custom decade-item"></div>');
                            const checkboxAndLabelDiv = $('<div class="checkbox-and-label"></div>');

                            const decadeCheckbox = $('<input type="checkbox" class="form-check-input decade-checkbox checkbox-custom" value="' + decade + '" id="decade-' + decade + '">');
                            const decadeLabel = $('<label class="form-check-label" for="decade-' + decade + '">Années ' + decade + '</label>');

                            checkboxAndLabelDiv.append(decadeCheckbox).append(decadeLabel);

                            const chevronIcon = $('<img src="' + chevronIconPath + '" class="chevron-icon decade-chevron" alt="chevron">');

                            decadeDiv.append(checkboxAndLabelDiv).append(chevronIcon);
                            decadesFilter.append(decadeDiv);

                            // Coche/Décoche la décennie si toutes les années sont cochées/décochées
                            const allSelected = years.every(year => selectedYears.has(parseInt(year)));
                            const someSelected = years.some(year => selectedYears.has(parseInt(year)));

                            decadeCheckbox.prop('checked', allSelected);
                            decadeCheckbox[0].indeterminate = someSelected && !allSelected;
                            if (someSelected && !allSelected) {
                                console.log("decadeCheckbox", decadeCheckbox);
                                console.log("decadeCheckbox[0]", decadeCheckbox[0]);
                                console.log("Indeterminate state set to:", someSelected && !allSelected);
                            }
                            console.log("decadeCheckbox", decadeCheckbox);
                            console.log("decadeCheckbox[0]", decadeCheckbox[0]);
                            console.log("Indeterminate state set to:", someSelected && !allSelected);

                            decadeCheckbox.on('change', function () {
                                const checkboxElement = this;
                                const isChecked = $(checkboxElement).is(':checked');
                                const isIndeterminate = checkboxElement.indeterminate;

                                if (isIndeterminate) {
                                    // Si la case à cocher est dans un état intermédiaire, déselectionnez toutes les années
                                    years.forEach(year => {
                                        selectedYears.delete(parseInt(year));
                                    });
                                    checkboxElement.indeterminate = false; // Réinitialisez l'état intermédiaire
                                    $(checkboxElement).prop('checked', false); // Assurez-vous que la checkbox est décochée
                                } else if (isChecked) {
                                    // Si la case à cocher est cochée, sélectionnez toutes les années
                                    years.forEach(year => {
                                        selectedYears.add(parseInt(year));
                                    });
                                } else {
                                    // Si la case à cocher est décochée, déselectionnez toutes les années
                                    years.forEach(year => {
                                        selectedYears.delete(parseInt(year));
                                    });
                                }

                                updateFilters();
                                $('#survey-table').DataTable().ajax.reload();
                            });


                            chevronIcon.on('click', function () {
                                loadYears(decade);
                            });
                        });
                    }
                });
            }





            function loadYears(decade) {
                $.ajax({
                    url: '/get-years-by-decade/',
                    type: 'GET',
                    data: {decade: decade},
                    success: function (data) {
                        const decadesFilter = $('#years-filter');
                        decadesFilter.empty();
                        const chevronIconPathReturn = '{% static "svg/icons/chevron_left.svg" %}';

                        const backButton = $('<img src="' + chevronIconPathReturn + '" class="back-button" alt="Retour">');
                        backButton.on('click', function () {
                            loadDecades();
                        });
                        decadesFilter.append(backButton);

                        data.years.forEach(year => {
                            const yearDiv = $('<div class="form-check-custom year-item"></div>');

                            const yearCheckbox = $('<input type="checkbox" class="form-check-input year-checkbox checkbox-custom" value="' + year + '" id="year-' + year + '">');
                            const yearLabel = $('<label class="form-check-label" for="year-' + year + '">' + year + '</label>');

                            if (selectedYears.has(year)) {
                                yearCheckbox.prop('checked', true);
                            }

                            yearDiv.append(yearCheckbox).append(yearLabel);
                            decadesFilter.append(yearDiv);

                            yearCheckbox.on('change', function () {
                                const year = $(this).val();
                                if ($(this).is(':checked')) {
                                    selectedYears.add(parseInt(year));
                                } else {
                                    selectedYears.delete(parseInt(year));
                                }
                                updateFilters();
                                $('#survey-table').DataTable().ajax.reload();
                                updateDecadeCheckboxes(data);
                            });
                        });
                    }
                });
            }

            function getYearsFilter() {
                return Array.from(selectedYears);
            }

            // Ensemble pour stocker les années sélectionnées
            const selectedYears = new Set();

            // Fonction pour mettre à jour les filtres
            function updateFilters() {
                // const yearsArray = Array.from(selectedYears);
                console.log("selected years update filters : ", selectedYears)
                $('#survey-table').DataTable().ajax.reload();
            }


            // Charger les décennies au chargement de la page
            loadDecades();

            function updateDecadeCheckboxes(data) {
                $('.decade-checkbox').each(function () {
                    const decade = $(this).val();
                    const years = data.decades[decade] || [];
                    const allSelected = years.every(year => selectedYears.has(parseInt(year)));
                    const someSelected = years.some(year => selectedYears.has(parseInt(year)));

                    $(this).prop('checked', allSelected);
                    this.indeterminate = someSelected && !allSelected;
                });
            }




            $('#reset-filters').on('click', function() {
                selectedFilters = {}; // Reset the filters object
                selectedIds.clear(); // Clear selected IDs

                // Uncheck all checkboxes
                $('.form-check-input').prop('checked', false);

                updateFiltersDisplay(); // Update filter cards displayed
                $('#survey-table').DataTable().ajax.reload(); // Reload table data
            });


            function updateFilterCounts() {
                $('.accordion-item').each(function () {
                    var accordionItem = $(this);
                    var checkboxes = accordionItem.find('.form-check-input:checked');
                    var count = checkboxes.length;
                    var filterCountElement = accordionItem.find('.filter-count');

                    if (count > 0) {
                        filterCountElement.text(count).show();
                    } else {
                        filterCountElement.hide();
                    }
                });
            }

            updateFilterCounts();

            $('.form-check-input').on('change', function () {
                updateFilterCounts();
            });


        });

        function toggleCategories(categoryId) {
            var categoriesDiv = document.getElementById(categoryId);
            if (categoriesDiv.style.display === "none") {
                categoriesDiv.style.display = "block";
            } else {
                categoriesDiv.style.display = "none";
            }
        }

        function getSelectedFiltersContainerHeight() {
            var container = $('#selected-filters-container');
            if (container.is(':visible')) {
                return container.outerHeight(true);
            } else {
                return 0;
            }
        }

        function updateTableContainerHeight() {
            var selectedFiltersContainerHeight = getSelectedFiltersContainerHeight();
            document.documentElement.style.setProperty('--selected-filters-container-height', selectedFiltersContainerHeight + 'px');
        }

        $(document).ready(function () {
            updateTableContainerHeight();

            var observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.attributeName === "style") {
                        updateTableContainerHeight();
                    }
                });
            });
            var targetNode = document.getElementById('selected-filters-container');
            var config = {attributes: true, attributeFilter: ['style']};

            // Démarrer l'observation
            observer.observe(targetNode, config);
        });

        $(window).resize(function () {
            updateTableContainerHeight();
        });

    </script>
{% endblock %}