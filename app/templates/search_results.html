{% extends 'base.html' %}
{% load static %}

{% block content %}
    <div class="inner-container-custom d-flex">
        <div class="search-results-container w-70 border-right-custom">
            <div class="height_topbar d-flex justify-content-between align-items-center custom-topbar border-bottom-custom">
                <div class="export-container custom-body d-flex justify-content-between align-items-center">
                    <span id="results-count">0 r√©sultats</span>
                    <div class="d-flex align-items-center container-buttons-export">
                        <div id="export-selected" class="white-button custom-text-white-buttons" type="button">
                            <img src="{% static 'svg/icons/export.svg' %}">
                            <span>Exporter la s√©lection</span>
                        </div>
                        <div id="export-all" class="white-button custom-text-white-buttons" type="button">
                            <img src="{% static 'svg/icons/export.svg' %}">
                            <span>Tout exporter</span>
                        </div>
                    
                    </div>
                </div>
            </div>
            <div id="selected-filters-container" class="selected-filters-container overflow-auto">
            </div>
            <div class="table-container">
                <table id="survey-table" class="" style="width:100%">
                    <thead class="table-dark" style="display:none">
                    <tr>
                        <th>Enqu√™te</th>
                    </tr>
                    </thead>
                </table>
                <div class="container-button-load-more">
                    <div type="button" id="load-more" class="load-more-button white-button custom-text-white-buttons">Charger plus</div>
                </div>
            </div>
        </div>
        <div class="filters-container w-30">
            <div class="height_topbar border-bottom-custom padding-filters-container">
                <div class="custom-body color-grey-1">
                    Filtrer par
                </div>
            </div>
            <div class="accordion" id="filtersAccordion">
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingOne">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                            <div class="collapse-title">
                                <span>Types de m√©tadonn√©es</span>
                                <span class="filter-count"></span>
                            </div>
                            <i class="fas fa-caret-down icon-caret"></i>
                        </div>
                    </div>
                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" >
                        <div class="accordion-body">
                            <div id="search-location" class="div-all-checkboxes">
                                <div class="form-check-custom">
                                    <input class="form-check-input search-location-checkbox checkbox-custom" type="checkbox" value="questions" id="search-location-questions">
                                    <label class="form-check-label" for="search-location-questions">Questions</label>
                                </div>
                                <div class="form-check-custom">
                                    <input class="form-check-input search-location-checkbox checkbox-custom" type="checkbox" value="categories" id="search-location-categories">
                                    <label class="form-check-label" for="search-location-categories">Modalit√©s</label>
                                </div>
                                <div class="form-check-custom">
                                    <input class="form-check-input search-location-checkbox checkbox-custom" type="checkbox" value="variable_name" id="search-location-variable_name">
                                    <label class="form-check-label" for="search-location-variable_name">Nom de la variable</label>
                                </div>
                                <div class="form-check-custom">
                                    <input class="form-check-input search-location-checkbox checkbox-custom" type="checkbox" value="internal_label" id="search-location-internal_label">
                                    <label class="form-check-label" for="search-location-internal_label">Libell√© de la variable</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingTwo">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            <div class="collapse-title">
                                <span>Collections</span>
                                <span class="filter-count"></span>
                            </div>
                            <i class="fas fa-caret-down icon-caret"></i>
                        </div>
                    </div>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" >
                        <div class="accordion-body">
                            <div id="collections-filter" class="div-all-checkboxes">
                                {% for collection in collections %}
                                    <div class="form-check-custom">
                                        <input class="form-check-input collection-checkbox checkbox-custom" type="checkbox" value="{{ collection.id }}" id="collection-{{ collection.id }}" {% if collection.id|stringformat:"s" in request.session.selected_collection %}checked{% endif %}>
                                        <label class="form-check-label" for="collection-{{ collection.id }}">
                                            {{ collection.name }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingThree">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            <div class="collapse-title">
                                <span>Sous-Collections</span>
                                <span class="filter-count"></span>
                            </div>
                            <i class="fas fa-caret-down icon-caret"></i>
                        </div>
                    </div>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree">
                        <div class="accordion-body">
                            <div id="subcollections-filter" class="div-all-checkboxes">
                                {% for subcollection in subcollections %}
                                    <div class="form-check-custom">
                                        <input class="form-check-input subcollection-checkbox checkbox-custom" type="checkbox" value="{{ subcollection.id }}" id="subcollection-{{ subcollection.id }}" {% if subcollection.id|stringformat:"s" in request.session.selected_sub_collection %}checked{% endif %}>
                                        <label class="form-check-label" for="subcollection-{{ subcollection.id }}">
                                            {{ subcollection.name }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingFour">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button" data-toggle="collapse" data-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                            <div class="collapse-title">
                                <span>Enqu√™tes</span>
                                <span class="filter-count"></span>
                            </div>
                            <i class="fas fa-caret-down icon-caret"></i>
                        </div>
                    </div>
                    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" >
                        <div class="accordion-body">
                            <div id="survey-filter" class="div-all-checkboxes">
                                {% for survey in surveys %}
                                    <div class="form-check-custom">
                                        <input class="form-check-input survey-checkbox checkbox-custom" type="checkbox" value="{{ survey.id }}" id="survey-{{ survey.id }}" {% if survey.id|stringformat:"s" in request.session.selected_surveys %}checked{% endif %}>
                                        <label class="form-check-label" for="survey-{{ survey.id }}">
                                            {{ survey.name }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item accordion-item-custom padding-filters-container">
                    <div class="accordion-header" id="headingFive">
                        <div class="accordion-button collapsed custom-body color-grey-1" type="button" data-toggle="collapse" data-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                            <div class="collapse-title">
                                <span>Ann√©es</span>
                                <span class="filter-count"></span>
                            </div>
                            <i class="fas fa-caret-down icon-caret"></i>
                        </div>
                    </div>
                    <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive">
                        <div class="accordion-body" class="div-all-checkboxes">
                            <div id="years-filter">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="reset-filters-container padding-filters-container">
                <div class="container-reset-button">
                    <div type="button" id="reset-filters" class="white-button custom-text-white-buttons">
                        <img src="{% static 'svg/icons/reset.svg' %}" class="reset-icon" alt="reset-icon">
                        <span>R√©initialiser</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/search_results.css' %}">
    <style>
        
        :root {
            --selected-filters-container-height: 0px;
        }
        .inner-container-custom{
            --topbar-height : 64px;
            --resetbar-height : 64px;
        }
        .search-results-container {
            width: 70%;
            overflow: hidden;
        }
        .filters-container {
            width: 30%;
        }
        .badge-category {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #007bff;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.8em; /* Taille des lettres du badge */
            cursor: pointer;
            z-index: 1; /* S'assurer que le badge est au-dessus du texte */
            width: 15rem;
        }
        .category-dropdown {
            display: none;
            position: absolute;
            top: 30px;
            right: 10px;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1;
            width: 15rem;
            padding: 10px;
            border-radius: 3px;
            max-height: calc(100% - 40px); /* Limite √† la hauteur de la carte parent, en laissant 40px de marge */
            overflow-y: auto; /* Scroll si n√©cessaire */
        }
        .category-item {
            padding: 5px;
            font-size: 0.75em; /* R√©duit la taille du texte dans les cat√©gories */
        }
        .highlight-category {
            background-color: rgba(255, 70, 78, 0.15);
            font-weight: bold;
        }
        .category-dropdown a {
            display: block;
            padding: 5px;
            text-decoration: none;
            color: black;
            font-size: 0.75em; /* R√©duit la taille du texte dans les liens */
        }
        .category-dropdown a:hover {
            background-color: #f1f1f1;
        }
        .card {
            position: relative; /* Important pour confiner le dropdown √† la carte */
            margin-bottom: 20px;
            overflow: hidden; /* Emp√™che le d√©passement du contenu */
        }
        .bootstrap-select .btn {
            max-width: 200px;
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
{% endblock %}

{% block extra_js %}
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>

    <script>
        // ---------------------------
        // 1. Variables globales
        // ---------------------------
        var selectedIds = new Set();
        var selectedFilters = {};
        const selectedYears = new Set();
        var currentLimit = 10;
        var table;

        // ---------------------------
        // 2. Fonctions utilitaires
        // ---------------------------
        function getFilterValues(className) {
            return $(`.${className}:checked`).map(function () {
                return this.value;
            }).get();
        }

        function getSearchLocation() {
            return getFilterValues('search-location-checkbox');
        }

        function getYearsFilter() {
            return Array.from(selectedYears);
        }

        function toggleCategories(categoryId) {
            var categoriesDiv = document.getElementById(categoryId);
            var caretIcon = event.currentTarget.querySelector('.icon-caret');

            if (categoriesDiv.style.display === "none" || !categoriesDiv.style.display) {
                categoriesDiv.style.display = "block";
                caretIcon.classList.add('rotated');
            } else {
                categoriesDiv.style.display = "none";
                caretIcon.classList.remove('rotated');
            }
        }

        function updateTableContainerHeight() {
            const selectedFiltersContainer = $('#selected-filters-container');
            if (selectedFiltersContainer.is(':visible') && selectedFiltersContainer.children().length > 0) {
                const height = selectedFiltersContainer.outerHeight(true);
                document.documentElement.style.setProperty('--selected-filters-container-height', height + 'px');
            } else {
                document.documentElement.style.setProperty('--selected-filters-container-height', '0px');
            }
        }

        function updateDecadeCheckboxes(data) {

            if (!data || !data.decades_by_year) {
                return;
            }

            Object.entries(data.decades_by_year).forEach(([decade, years]) => {
                const allSelected = years.every(year => selectedYears.has(parseInt(year)));
                const someSelected = years.some(year => selectedYears.has(parseInt(year)));

                const checkbox = document.getElementById(`decade-${decade}`);
                if (checkbox) {
                    checkbox.checked = allSelected;
                    checkbox.indeterminate = someSelected && !allSelected;
                }
            });
        }

        function waitForElement(selector, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const intervalTime = 100;
                let timeElapsed = 0;

                const interval = setInterval(() => {
                    if ($(selector).length > 0) {
                        clearInterval(interval);
                        resolve();
                    } else if (timeElapsed >= timeout) {
                        clearInterval(interval);
                        reject(`‚è∞ √âl√©ment "${selector}" introuvable apr√®s ${timeout} ms`);
                    }
                    timeElapsed += intervalTime;
                }, intervalTime);
            });
        }

        function addYearToFilters(year) {
            const yearStr = year.toString();
            selectedYears.add(parseInt(yearStr));
            if (!selectedFilters['year']) selectedFilters['year'] = [];
            if (!selectedFilters['year'].some(f => f.value === yearStr)) {
                selectedFilters['year'].push({ value: yearStr, label: `Ann√©e ${yearStr}` });
            }
        }


        function resetDependentFilters() {
            // R√©initialiser les sous-collections
            $('.subcollection-checkbox').prop('checked', false);
            // R√©initialiser les enqu√™tes
            $('.survey-checkbox').prop('checked', false);
            // R√©initialiser les filtres s√©lectionn√©s
            selectedFilters['subcollection'] = [];
            selectedFilters['survey'] = [];
            updateFiltersDisplay();
            updateFilterCounts();
        }

        function resetDependentSurveyFilters() {
            // R√©initialiser les enqu√™tes
            $('.survey-checkbox').prop('checked', false);
            // R√©initialiser les filtres s√©lectionn√©s pour les enqu√™tes
            selectedFilters['survey'] = [];
            updateFiltersDisplay();
            updateFilterCounts();
        }

        // ---------------------------
        // 3. Filtres : affichage, comptage, reset
        // ---------------------------
        function updateFiltersDisplay() {
            const filterContainer = $('#selected-filters-container');
            filterContainer.empty();

            let hasFilters = false;

            $.each(selectedFilters, function (key, filters) {
                const validFilters = filters.filter(function (filter) {
                    // ‚úÖ Toujours garder les ann√©es, m√™me si leur checkbox n'est pas dans le DOM
                    if (key === 'year') return true;
                    return $('input[type="checkbox"][value="' + filter.value + '"]').length > 0;
                });

                selectedFilters[key] = validFilters;

                if (validFilters.length > 0) {
                    hasFilters = true;
                    validFilters.forEach(function (filter) {
                        const crossIconPath = '{% static "svg/icons/cross.svg" %}';
                        var card = $('<div class="selected-filter-card"> <span>' + filter.label + '</span><img type="button" class="remove-filter" src="' + crossIconPath + '"></div>');
                        card.find('.remove-filter').click(function () {
                            var index = selectedFilters[key].findIndex(f => f.value === filter.value);
                            if (index !== -1) {
                                selectedFilters[key].splice(index, 1);

                                // D√©coche la checkbox si elle existe dans le DOM
                                $('input[type="checkbox"][value="' + filter.value + '"]').prop('checked', false);

                                // Supprime aussi l'ann√©e du Set
                                if (key === 'year') {
                                    selectedYears.delete(parseInt(filter.value));
                                }

                                updateFiltersDisplay();
                                updateFilterCounts();
                                $('#survey-table').DataTable().ajax.reload();
                            }
                        });

                        filterContainer.append(card);
                    });
                }
            });


            if (hasFilters) {
                filterContainer.show();
            } else {
                filterContainer.hide();
            }
            updateTableContainerHeight();
        }

        function updateFilterCounts() {
            $('.accordion-item').each(function () {
                var accordionItem = $(this);
                var checkboxes = accordionItem.find('.form-check-input:checked');
                var count = checkboxes.length;
                var filterCountElement = accordionItem.find('.filter-count');

                if (count > 0) {
                    filterCountElement.text(count).css('display', 'flex').show();
                } else {
                    filterCountElement.hide();
                }
            });

            // ‚úÖ Mise √† jour sp√©cifique pour les ann√©es
            const yearCount = selectedYears.size;
            const yearFilterCount = $('#headingFive .filter-count');
            if (yearCount > 0) {
                yearFilterCount.text(yearCount).show();
            } else {
                yearFilterCount.hide();
            }
        }


        // ---------------------------
        // 4. Chargement AJAX
        // ---------------------------
        function loadDecades() {
            return new Promise((resolve, reject) => {
                const collections = getFilterValues('collection-checkbox');
                const subcollections = getFilterValues('subcollection-checkbox');
                const surveys = getFilterValues('survey-checkbox');

                $.ajax({
                    url: '/api/get-decades/',
                    type: 'GET',
                    data: {
                        collections_ids: collections.join(','),
                        subcollections_ids: subcollections.join(','),
                        survey_ids: surveys.join(',')
                    },
                    success: function (data) {
                        const decadesFilter = $('#years-filter');
                        decadesFilter.empty();
                        const sortedDecades = Object.keys(data.decades).sort((a, b) => b - a);

                        sortedDecades.forEach(decade => {
                            const years = data.decades[decade];
                            const chevronIconPath = '{% static "svg/icons/chevron_right.svg" %}';
                            const decadeDiv = $('<div class="form-check-custom decade-item"></div>');
                            const checkboxAndLabelDiv = $('<div class="checkbox-and-label"></div>');

                            const decadeCheckbox = $('<input type="checkbox" class="form-check-input decade-checkbox checkbox-custom" value="' + decade + '" id="decade-' + decade + '">');
                            const decadeLabel = $('<label class="form-check-label" for="decade-' + decade + '">Ann√©es ' + decade + '</label>');

                            checkboxAndLabelDiv.append(decadeCheckbox).append(decadeLabel);

                            const chevronIcon = $('<img src="' + chevronIconPath + '" class="chevron-icon decade-chevron" alt="chevron">');

                            decadeDiv.append(checkboxAndLabelDiv).append(chevronIcon);
                            decadesFilter.append(decadeDiv);

                            const allSelected = years.every(year => selectedYears.has(parseInt(year)));
                            const someSelected = years.some(year => selectedYears.has(parseInt(year)));

                            decadeCheckbox.prop('checked', allSelected);
                            decadeCheckbox[0].indeterminate = someSelected && !allSelected;

                            decadeCheckbox.on('change', function () {
                                const isChecked = this.checked;
                                const isIndeterminate = this.indeterminate;

                                if (isIndeterminate) {
                                    years.forEach(year => {
                                        selectedYears.delete(parseInt(year));
                                        if (selectedFilters['year']) {
                                            selectedFilters['year'] = selectedFilters['year'].filter(f => f.value !== year.toString());
                                        }
                                    });
                                    this.indeterminate = false;
                                    $(this).prop('checked', false);
                                } else if (isChecked) {
                                    years.forEach(year => {
                                        selectedYears.add(parseInt(year));
                                        if (!selectedFilters['year']) selectedFilters['year'] = [];
                                        if (!selectedFilters['year'].some(f => f.value === year.toString())) {
                                            selectedFilters['year'].push({value: year.toString(), label: `Ann√©e ${year}`});
                                        }
                                    });
                                } else {
                                    years.forEach(year => {
                                        selectedYears.delete(parseInt(year));
                                        if (selectedFilters['year']) {
                                            selectedFilters['year'] = selectedFilters['year'].filter(f => f.value !== year.toString());
                                        }
                                    });
                                }

                                updateFiltersDisplay();
                                updateFilterCounts();
                                updateFilters();
                                $('#survey-table').DataTable().ajax.reload();
                            });

                            chevronIcon.on('click', function () {
                                loadYears(decade);
                            });
                        });

                        resolve(); // ‚úÖ Important pour pouvoir await cette fonction
                    },
                    error: function () {
                        reject();
                    }
                });
            });
        }

        function loadYears(decade) {
            const collections = getFilterValues('collection-checkbox');
            const subcollections = getFilterValues('subcollection-checkbox');
            const surveys = getFilterValues('survey-checkbox');
            $.ajax({
                url: '/api/get-years-by-decade/',
                type: 'GET',
                data: {
                    decade: decade,
                    collections_ids: collections.join(','),
                    subcollections_ids: subcollections.join(','),
                    survey_ids: surveys.join(',')
                },
                success: function (data) {
                    const decadesFilter = $('#years-filter');
                    decadesFilter.empty();
                    const chevronIconPathReturn = '{% static "svg/icons/chevron_left.svg" %}';

                    const backButton = $('<img src="' + chevronIconPathReturn + '" class="back-button" alt="Retour">');
                    backButton.on('click', function () {
                        loadDecades();
                    });
                    decadesFilter.append(backButton);

                    data.years.forEach(year => {
                        const yearDiv = $('<div class="form-check-custom year-item"></div>');

                        const yearCheckbox = $('<input type="checkbox" class="form-check-input year-checkbox checkbox-custom" value="' + year + '" id="year-' + year + '">');
                        const yearLabel = $('<label class="form-check-label" for="year-' + year + '">' + year + '</label>');

                        if (selectedYears.has(year)) {
                            yearCheckbox.prop('checked', true);
                        }

                        yearDiv.append(yearCheckbox).append(yearLabel);
                        decadesFilter.append(yearDiv);

                        yearCheckbox.on('change', function () {
                            const year = parseInt($(this).val());
                            if ($(this).is(':checked')) {
                                addYearToFilters(year);
                            } else {
                                selectedYears.delete(year);
                                if (selectedFilters['year']) {
                                    selectedFilters['year'] = selectedFilters['year'].filter(f => f.value !== year.toString());
                                }
                            }


                            updateFiltersDisplay();
                            updateDecadeCheckboxes(data);
                            updateFilterCounts();
                            $('#survey-table').DataTable().ajax.reload();
                        });


                    });
                }
            });
        }

        function updateSubcollections(selectedCollections) {
            fetch(`/api/get-subcollections-by-collections/?collections_ids=${selectedCollections.join(',')}`)
                .then(response => response.json())
                .then(data => {
                    const subcollectionsFilter = $('#subcollections-filter');
                    subcollectionsFilter.empty();
                    const availableSubcollectionIds = data.subcollections.map(subcollection => subcollection.id);
                    data.subcollections.forEach(subcollection => {
                        const checkbox = $('<input type="checkbox" class="form-check-input subcollection-checkbox checkbox-custom" value="' + subcollection.id + '" id="subcollection-' + subcollection.id + '">');
                        const label = $('<label class="form-check-label" for="subcollection-' + subcollection.id + '">' + subcollection.name + '</label>');
                        const div = $('<div class="form-check-custom"></div>');
                        div.append(checkbox).append(label);
                        subcollectionsFilter.append(div);
                    });
                    $('.subcollection-checkbox').each(function () {
                        const subcollectionId = $(this).val();
                        if (!availableSubcollectionIds.includes(subcollectionId)) {
                            $(this).prop('checked', false);
                        }
                    });

                    attachDynamicCheckboxEvents();
                    updateFilterCounts();
                    const allSubcollections = data.subcollections.map(subcollection => subcollection.id);
                    updateSurveys(allSubcollections);
                });
        }

        function updateSurveys(selectedSubcollections) {
            fetch(`/api/get-surveys-by-subcollections/?subcollections_ids=${selectedSubcollections.join(',')}`)
                .then(response => response.json())
                .then(data => {
                    const surveysFilter = $('#survey-filter');
                    surveysFilter.empty();
                    const availableSurveyIds = data.surveys.map(survey => survey.id);
                    data.surveys.forEach(survey => {
                        const checkbox = $('<input type="checkbox" class="form-check-input survey-checkbox checkbox-custom" value="' + survey.id + '" id="survey-' + survey.id + '">');
                        const label = $('<label class="form-check-label" for="survey-' + survey.id + '">' + survey.name + '</label>');
                        const div = $('<div class="form-check-custom"></div>');
                        div.append(checkbox).append(label);
                        surveysFilter.append(div);
                    });
                    $('.survey-checkbox').each(function () {
                        const surveyId = $(this).val();
                        if (!availableSurveyIds.includes(surveyId)) {
                            $(this).prop('checked', false);
                        }
                    });
                    attachDynamicCheckboxEvents();
                    updateFiltersDisplay();
                    updateFilterCounts();
                });
        }

        // Fonction pour mettre √† jour les filtres
        function updateFilters() {
            $('#survey-table').DataTable().ajax.reload();
        }

        function handleFilterChange(filterType, filterValue, filterLabel) {
            selectedIds.clear();
            if (!selectedFilters[filterType]) {
                selectedFilters[filterType] = [];
            }

            // Check if the filter is already selected and remove if necessary
            var existingFilterIndex = selectedFilters[filterType].findIndex(f => f.value === filterValue);
            if (existingFilterIndex !== -1) {
                selectedFilters[filterType].splice(existingFilterIndex, 1); // De-select the filter
            } else {
                selectedFilters[filterType].push({value: filterValue, label: filterLabel}); // Add filter
            }

            updateFiltersDisplay();
            loadDecades(); //
            $('#survey-table').DataTable().ajax.reload(); // Reload based on new filters
        }

        function updateCheckboxes() {
                $('#survey-table tbody input[type="checkbox"]').each(function() {
                    if (selectedIds.has(this.value)) {
                        this.checked = true;
                    } else {
                        this.checked = false;
                    }
                });
            }

        async function applyFiltersFromURL() {
            const urlParams = new URLSearchParams(window.location.search);

            // Texte de recherche
            const q = urlParams.get('q');
            if (q) {
                $('input[name="q"]').val(q);
            }

            // √âtape 1 : cocher les collections
            const collections = urlParams.getAll('collections');
            collections.forEach(val => {
                $(`.collection-checkbox[value="${val}"]`).prop('checked', true).trigger('change');
            });

            // √âtape 2 : charger les sous-collections si n√©cessaire
            const subCollections = urlParams.getAll('sub_collections');
            if (collections.length > 0 || subCollections.length > 0) {
                if (collections.length === 0) {
                    await waitForElement('.collection-checkbox');
                    const allCollectionIds = $('.collection-checkbox').map(function () {
                        return this.value;
                    }).get();
                    updateSubcollections(allCollectionIds);
                }

                await waitForElement('.subcollection-checkbox');
                subCollections.forEach(val => {
                    $(`.subcollection-checkbox[value="${val}"]`).prop('checked', true).trigger('change');
                });
            }

            // √âtape 3 : cocher les enqu√™tes
            const surveys = urlParams.getAll('survey');
            if (surveys.length > 0) {
                await waitForElement('.survey-checkbox');
                surveys.forEach(val => {
                    $(`.survey-checkbox[value="${val}"]`).prop('checked', true).trigger('change');
                });
            }

            // √âtape 4 : cocher les lieux de recherche
            const searchLocations = urlParams.getAll('search_location');
            searchLocations.forEach(val => {
                $(`.search-location-checkbox[value="${val}"]`).prop('checked', true).trigger('change');
            });

            // √âtape 5 : charger les d√©cennies
            await loadDecades();

            // √âtape 6 : g√©rer les ann√©es individuelles
            const years = urlParams.getAll('years');

            // Ajouter les ann√©es au Set et aux filtres
            years.forEach(year => {
                addYearToFilters(parseInt(year));
            });


            // √âtape 7 : ouvrir les d√©cennies concern√©es et cocher les ann√©es
            const decadesToOpen = new Set();
            years.forEach(year => {
                const decade = Math.floor(parseInt(year) / 10) * 10;
                decadesToOpen.add(decade);
            });

            for (const decade of decadesToOpen) {
                await loadYears(decade.toString());

                years.forEach(year => {
                    if (Math.floor(parseInt(year) / 10) * 10 === decade) {
                        const checkbox = $(`.year-checkbox[value="${year}"]`);
                        if (checkbox.length > 0) {
                            checkbox.prop('checked', true);
                            addYearToFilters(parseInt(year)); // <--
                        }
                    }
                });
            }

            // √âtape 8 : mise √† jour finale
            updateFiltersDisplay();
            updateFilterCounts();
            $('#survey-table').DataTable().ajax.reload();
        }




        // ---------------------------
        // 5. Initialisation DataTable
        // ---------------------------
        function initializeDataTable() {
            table = $('#survey-table').DataTable({
        "processing": true,
        "serverSide": true,
        "paging": false,
        "dom": 'rt',
        "info": false,
        "ordering": false,
        "drawCallback": function(settings) {
            updateCheckboxes();
        },

        "ajax": {
            "url": "{% url 'app:search_results_data' %}",
            "type": "POST",
            "async": true,
            "data": function (d) {
                d.start = d.start || 0;
                d.limit = currentLimit;
                d.q = "{{ request.GET.q }}";
                d.survey = getFilterValues('survey-checkbox');
                d.collections = getFilterValues('collection-checkbox');
                d.sub_collections = getFilterValues('subcollection-checkbox')
                d.search_location = getSearchLocation();
                d.years = getYearsFilter();
            },
            "headers": {'X-CSRFToken': $("input[name=csrfmiddlewaretoken]").val()},
            "dataSrc": function (json) {
                totalRecords = json.recordsTotal;
                currentRecords = json.data.length;
                $('#results-count').text(totalRecords + ' r√©sultats');
                if (currentRecords < totalRecords) {
                    $('#load-more').show();
                } else {
                    $('#load-more').hide();
                }
                return json.data;
            },
            "error": function (jqXHR, textStatus, errorThrown) {
                console.error('DataTables AJAX Error:', textStatus, errorThrown);
            }
        },
        "columns": [
            {
                "data": "id",
                "render": function (data, type, row) {
                    const searchParams = new URLSearchParams();

                    // Texte recherch√© (depuis le champ input)
                    const searchInput = document.querySelector('input[name="q"]');
                    if (searchInput && searchInput.value) {
                        searchParams.set('q', searchInput.value);
                    }

                    // Filtres dynamiques
                    getFilterValues('survey-checkbox').forEach(val => searchParams.append('survey', val));
                    getFilterValues('collection-checkbox').forEach(val => searchParams.append('collections', val));
                    getFilterValues('subcollection-checkbox').forEach(val => searchParams.append('sub_collections', val));
                    getYearsFilter().forEach(val => searchParams.append('years', val));
                    getSearchLocation().forEach(val => searchParams.append('search_location', val));


                    const url = '/question/' + row.id + '/?' + searchParams.toString();

                    var categoriesDisplay = row.categories;
                    var survey_doi = row.survey_doi;
                    var doiUrl = 'https://doi.org/' + survey_doi;
                    var hasHighlightedModalities = row.is_category_search && row.categories && row.categories.includes('<mark style=');
                    var caretIcon = hasHighlightedModalities ?
                        '<span class="background-red-caret"><img src="{% static "svg/buttons/caret_down.svg" %}" alt="Caret Down" class="icon-caret"></span>' :
                        '<img src="{% static "svg/buttons/caret_down.svg" %}" alt="Caret Down" class="icon-caret">'

                    return `
                                    <div class="custom-card-dt">
                                        <div class="custom-content-card">
                                            <div class="custom-card-first-part">
                                                <div class="title-checkbox">
                                                    <input type="checkbox" class="form-check-input checkbox-custom" value="${row.id}">
                                                    <div class="custom-title-2 custom-title-2-bold">
                                                        <a class="custom-name-card color-black-1" type="button" href="${url}">${row.question_text || row.internal_label}</a>

                                                    </div>
                                                </div>
                                                <div class="custom-metadatas">
                                                    <div class="flex-grow-1 d-flex flex-column inner-container-metadatas custom-body">
                                                        <div class="card-subtitle">Enqu√™te : <span class="ft-600"> ${row.survey_name} </span> </div>
                                                        <div class="card-subtitle">Nom de la variable : <span class="ft-600">${row.variable_name}</span></div>
                                                        <div class="card-subtitle">Libell√© de la variable : <span class="ft-600">${row.internal_label}</span></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="custom-card-second-part">
                                                <div class="container-buttons-card">
                                                    <span type="button" id="toggle-categories" onclick="toggleCategories('categories-${row.id}')" class="button-card button-modalities-card">
                                                        <img src="{% static 'svg/icons/modalites.svg' %}" alt="Modalit√©s" class="icon-modalites">
                                                        <span>Modalit√©s</span>
                                                        ${caretIcon}
                                                    </span>

                                                    <span type="button" onclick="window.location.href='${doiUrl}'" class="button-card button-access-data button-access-data-card-hover">
                                                        <img src="{% static 'svg/icons/doi.svg' %}" alt="Donn√©es" class="icon-access-data">
                                                        <span>Acc√©der aux donn√©es</span>
                                                    </span>
                                                </div>


                                                <div id="categories-` + row.id + `" class="categories-list mt-3" style="display: none;">
                                                    ` + categoriesDisplay + `
                                                </div>
                                            </div>

                                        </div>
                                    </div>`;
                }
            },
        ],
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.20/i18n/French.json",
            "emptyTable": "Aucun √©l√©ment √† afficher."
        }
    });
        }

        // ---------------------------
        // 6. Gestion des √©v√©nements
        // ---------------------------
        function attachDynamicCheckboxEvents() {
            $('.subcollection-checkbox, .survey-checkbox').off('change').on('change', function () {
                var checkbox = $(this);
                var filterType = checkbox.attr('class').split(' ')[1].split('-')[0];
                var filterValue = checkbox.val();
                var filterLabel = $('label[for="' + checkbox.attr('id') + '"]').text();

                handleFilterChange(filterType, filterValue, filterLabel);
                updateFilterCounts();
                // R√©initialiser les filtres d√©pendants pour les enqu√™tes
                resetDependentSurveyFilters();
                if (filterType === 'subcollection') {
                    const selectedSubcollections = $('.subcollection-checkbox:checked').map(function () {
                        return this.value;
                    }).get();

                    if (selectedSubcollections.length === 0) {
                        const allSubcollections = $('.subcollection-checkbox').map(function () {
                            return this.value;
                        }).get();
                        updateSurveys(allSubcollections);
                    } else {
                        updateSurveys(selectedSubcollections);
                    }
                }
                $('#survey-table').DataTable().ajax.reload();
            });
            $('.survey-checkbox').off('change').on('change', function () {
                var checkbox = $(this);
                var filterType = checkbox.attr('class').split(' ')[1].split('-')[0];
                var filterValue = checkbox.val();
                var filterLabel = $('label[for="' + checkbox.attr('id') + '"]').text();

                handleFilterChange(filterType, filterValue, filterLabel);
                updateFilterCounts();
            });
        }

        function attachStaticEventListeners() {
            $('.collection-checkbox, .search-location-checkbox').on('change', function () {
                var checkbox = $(this);
                var filterType = checkbox.attr('class').split(' ')[1].split('-')[0];
                var filterValue = checkbox.val();
                var filterLabel = $('label[for="' + checkbox.attr('id') + '"]').text();

                handleFilterChange(filterType, filterValue, filterLabel);
                updateFilterCounts();

                // R√©initialiser les filtres d√©pendants
                resetDependentFilters();

                if (filterType === 'collection') {
                    const selectedCollections = $('.collection-checkbox:checked').map(function () {
                        return this.value;
                    }).get();
                    updateSubcollections(selectedCollections);
                }

                $('#survey-table').DataTable().ajax.reload();
            });


            $('#reset-filters').on('click', async function () {
                selectedFilters = {};
                selectedIds.clear();
                selectedYears.clear(); // üîÅ Vide les ann√©es s√©lectionn√©es

                $('.form-check-input').prop('checked', false); // D√©coche toutes les cases visibles

                updateFiltersDisplay();
                updateFilterCounts();

                await loadDecades(); // üîÅ Recharge les d√©cennies et ann√©es (remet √† z√©ro l'affichage dynamique)

                table.ajax.reload();
            });

            $('#load-more').on('click', function () {
                currentLimit += 10;
                table.ajax.reload(updateCheckboxes, false);
            });

            $('#export-all').on('click', function () {
                const params = {};
                params.q = "{{ request.GET.q }}";
                params.survey = getFilterValues('survey-checkbox');
                params.collections = getFilterValues('collection-checkbox');
                params.sub_collections = getFilterValues('subcollection-checkbox');
                params.search_location = getSearchLocation();
                params.years = getYearsFilter();

                const searchParams = new URLSearchParams(params).toString();

                window.location.href = `/export/questions/?${searchParams}`;
            });

            $('#export-selected').on('click', function () {
                if (selectedIds.size === 0) {
                    Swal.fire({
                        html: `
                            <div style="text-align: center;">
                                <img src="{% static 'svg/icons/checkbox_checked_swal.svg' %}" alt="Checked Box" style="width: 32px; height: 32px;">
                            </div>
                            <div>
                                Veuillez s√©lectionner au moins une question √† exporter.
                            </div>
                        `,
                        confirmButtonText: 'Fermer',
                        confirmButtonColor: '#536254',
                        customClass: {
                            popup: 'custom-swal-popup custom-title-2',
                            confirmButton: 'custom-swal-button '
                        }
                    });
                    return;
                }
                const query = Array.from(selectedIds).map(id => `ids=${id}`).join('&');
                window.location.href = `/export/questions/?${query}`;
            });

            $('#survey-table tbody').on('change', 'input[type="checkbox"]', function () {
                if (this.checked) {
                    selectedIds.add(this.value);
                } else {
                    selectedIds.delete(this.value);
                }

                const all = $('#survey-table tbody input[type="checkbox"]');
                const checked = $('#survey-table tbody input[type="checkbox"]:checked');
                $('#select-all').prop('checked', all.length === checked.length);
                $('#select-all').prop('indeterminate', checked.length > 0 && all.length !== checked.length);
            });

            $(window).resize(updateTableContainerHeight);
        }

        // ---------------------------
        // 7. Ready: lancement initial
        // ---------------------------
        $(document).ready(async function () {
            document.documentElement.style.setProperty('--selected-filters-container-height', '0px');
            updateTableContainerHeight();
            initializeDataTable();
            attachStaticEventListeners();
            attachDynamicCheckboxEvents();
            await loadDecades();
            await applyFiltersFromURL();
            updateFiltersDisplay();
            updateFilterCounts();

            const targetNode = document.getElementById('selected-filters-container');
            if (targetNode) {
                const observer = new MutationObserver(function (mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === "style" || mutation.type === "childList") {
                            updateTableContainerHeight();
                        }
                    });
                });
                observer.observe(targetNode, { attributes: true, attributeFilter: ['style'], childList: true });
            }
        });
        document.querySelectorAll('.accordion-button').forEach(button => {
            button.addEventListener('click', function() {
                const caretIcon = this.querySelector('.icon-caret');
                caretIcon.classList.toggle('rotated');
            });
        });
    </script>
{% endblock %}
