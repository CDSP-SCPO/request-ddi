services:

  # -----------------------------------------------------
  # DJANGO BACKEND
  # -----------------------------------------------------
  basedequestions:
    image: question_base-backend:local
    container_name: basedequestions
    build:
      context: .
      dockerfile: Dockerfile

    environment:
      # DEBUG & SECRET
      DJANGO_DEBUG: ${DJANGO_DEBUG:-True}
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:-changeme-in-prod}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS:-localhost,127.0.0.1}

      # DATABASE
      POSTGRES_DB: ${POSTGRES_DB:-db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_HOST: ${POSTGRES_HOST:-db}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}

      # ELASTICSEARCH
      ELASTICSEARCH_URL: ${ELASTICSEARCH_URL:-http://elasticsearch:9200}
      ELASTICSEARCH_ADMIN_USER: ${ELASTICSEARCH_ADMIN_USER:-elastic}
      ELASTICSEARCH_ADMIN_PASSWORD: ${ELASTICSEARCH_ADMIN_PASSWORD:-elastic}

      # SECURITY
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS:-http://localhost}

      # LOGS
      LOGS_DIRECTORY: ${LOGS_DIRECTORY:-/app}

    # We are using the same user as we defined in the Dockerfile here. However,
    # for rootless podman, we need to map the host user to root user inside the container
    # to be able to make /app directory writable. So, for rootless podman we will need
    # to run using command 
    #
    # CONT_UID=0 CONT_GID=0 podman-compose up --build
    #
    # This means the process will be launched as root user in the container. But this is
    # not a security issue as root user in the container is mapped to current host
    # user which is normal unprivileged one in most of the cases.
    user: "${CONT_UID:-1000}:${CONT_GID:-1000}"
    ports:
      - "8000:8000"
    volumes:
      - ./:/app
    depends_on:
      - db
      - elasticsearch


  # -----------------------------------------------------
  # POSTGRES DATABASE
  # -----------------------------------------------------
  db:
    image: postgres:17-alpine
    container_name: db

    # Variables propres au service Postgres uniquement
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}

    volumes:
      - postgres_data_dev:/var/lib/postgresql/data


  # -----------------------------------------------------
  # ELASTICSEARCH
  # -----------------------------------------------------
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:9.2.0
    container_name: elasticsearch
    # Variables propres Ã  Elasticsearch uniquement
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      xpack.security.transport.ssl.enabled: "false"
      ES_JAVA_OPTS: -Xms2g -Xmx2g

    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data_dev:/usr/share/elasticsearch/data
    deploy:
      resources:
        limits:
          memory: 4G

# ---------------------------------------------------------
# VOLUMES
# ---------------------------------------------------------
volumes:
  postgres_data_dev:
  elasticsearch_data_dev:
